<link rel="import" href="../../bower_components/polymer/polymer-element.html">

<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-styles/color.html">
<link rel="import" href="../../bower_components/polymer/lib/mixins/gesture-event-listeners.html">

<link rel="import" href="../../bower_components/web-socket/web-socket.html">

<dom-module id="pixel-art-app">
  <template strip-whitespace>
    <style>
      :host {
        display: block;
      }

      .container {
        position: absolute;
        top: 0;
        left: 0;
        height: 100%;
        width: 100%;
        overflow: hidden;
        background: var(--paper-blue-grey-800);
      }

      #matrix {
        display: table;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) rotate(-90deg);
        border: 1px solid var(--paper-orange-700);
      }

      .row {
        display: table-row;
      }

      .pixel {
        display: table-cell;
        background: #000000;
        border: 1px solid var(--paper-orange-700);
      }

      .spacer {
        @apply --layout-flex;
      }

      #palette {
        display: inline-flex;
        @apply --layout-center;
      }

      #colors {
        display: inline-flex;
        @apply --layout-center;
      }

      .color {
        width: 100%;
        height: 100%;
      }

      #menu {
        display: inline-flex;
        @apply --layout-center;
      }

      paper-icon-button {
        color: white;
      }

      @media screen and (orientation: landscape) {
        #matrix {
          width: 80vh;
          height: 80vh;
        }
        #palette {
          width: 24vh;
          height: 100%;
          @apply --layout-vertical;
        }
        #colors {
          width: 10vh;
          height: 80vh;
          @apply --layout-vertical;
        }
        #menu {
          width: 20vh;
          height: 100vh;
          background: yellowgreen;
          @apply --layout-vertical;
        }
      }

      @media screen and (orientation: portrait) {
        #matrix {
          width: 80vw;
          height: 80vw;
        }
        #palette {
          width: 100%;
          height: 24vw;
          @apply --layout-horizontal;
        }
        #colors {
          width: 80vw;
          height: 10vw;
          @apply --layout-horizontal;
        }
        #menu {
          width: 100vw;
          height: 20vw;
          background: yellowgreen;
          @apply --layout-horizontal;
        }
      }
    </style>

    <div class="container">

      <!-- add pre-defined color palette -->
      <div id="palette">
        <span class="spacer"></span>
        <div id="colors">
          <div class="color" style="background: #FFFFFF; padding: 4px" on-tap="__setColor"></div>
          <div class="color" style="background: #000000" on-tap="__setColor"></div>
          <div class="color" style="background: #B22222" on-tap="__setColor"></div>
          <div class="color" style="background: #008000" on-tap="__setColor"></div>
          <div class="color" style="background: #00008B" on-tap="__setColor"></div>
          <div class="color" style="background: #FFFF00" on-tap="__setColor"></div>
          <div class="color" style="background: #40E0D0" on-tap="__setColor"></div>
          <div class="color" style="background: #EE82EE" on-tap="__setColor"></div>
        </div>
        <span class="spacer"></span>
      </div>

      <!-- add matrix -->
      <div id="matrix">
        <template is="dom-repeat" items="{{columns}}" index-as="y">
          <div class="row">
            <template is="dom-repeat" items="{{rows}}" index-as="x">
              <div id="[[__index(x, y)]]" class="pixel" on-click="__setPixelColor"></div>
            </template>
          </div>
        </template>
      </div>

      <div id="menu">
        <span class="spacer"></span>
        <paper-icon-button icon="favorite"></paper-icon-button>
        <span class="spacer"></span>
      </div>
    </div>

    <!-- add websocket support -->
    <web-socket id="ws" auto url="[[url]]" state="{{state}}" verbose></web-socket>
  </template>

  <script>
    class PixelArtApp extends Polymer.GestureEventListeners(Polymer.Element) {

      static get is() { return 'pixel-art-app'; }

      static get properties() {
        return {
          url: {
            type: String,
            value: 'ws://' + window.location.hostname + ':8000/matrix'
            //value: 'ws://' + window.location.hostname + ':80/matrix'
            //value: 'ws://esp8266.local:80/matrix'
          },
          state: {
            type: Number,
            observer: '__handleWSStateChanges',
            notify: true
          },
          color: {
            type: String,
            value: 'rgb(255, 255, 255)' // default is white and expected in rgb() notation
          },
          columns: {
            type: Array,
            value: new Array(8),
            readOnly: true
          },
          rows: {
            type: Array,
            value: new Array(8),
            readOnly: true
          }
        };
      }

      /**
       * Calculate a 8x8 matrix index from top left (0) to right until last pixel is reached.
       */
      __index(x, y) {
        // calculate index backwards for 8x8 matrix, so that first element of templating receives the highest ordinal number
        return (64 - (x * 8)) - (8 - y);
      }

      /**
       * Log WS state changes.
       */
      __handleWSStateChanges() {
        console.log("WS state: " + this.state);
      }

      /**
       * Set a new color value.
       */
      __setColor(event) {
        // save color value
        this.color = event.target.style.background;
        // palette effect ...
        // set all colors to default values
        var nodes = this.$.colors.querySelectorAll('div');
        for (var i = 0; i < nodes.length; i++) {
          nodes[i].style.padding = '0px';
        }
        // highlight selected color
        event.target.style.padding = '4px';
      }

      /**
       * Set target pixel corresponding to current color value and notify change via WS.  
       */
      __setPixelColor(event) {

        event.target.style.background = this.color;

        // TODO remove verbose note later
        console.log({ pixel: event.target.id, rgb: this.__parseRGB2Hex(this.color) });

        this.$.ws.send({ pixel: event.target.id, rgb: this.__parseRGB2Hex(this.color) });
      }

      /**
       * Return RGB-object from CSS 'rgb(red, green, blue)' string.
       */
      __parseRGB(rgb) {

        let matches = rgb.match(/^rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*(\d+))?\)$/);
        return { 'r': matches[1], 'g': matches[2], 'b': matches[3] };
      }

      /**
       * Return RGB as Hex value from CSS 'rgb(red, green, blue)' string.
       */
      __parseRGB2Hex(rgb) {

        let obj = this.__parseRGB(rgb);
        function hex(x) {
          return ("0" + parseInt(x).toString(16)).slice(-2);
        }
        return hex(obj.r) + hex(obj.g) + hex(obj.b);
      }

      __test(rgb) {

        var r = (rgb >> 16) & 0xFF;
        var g = (rgb >> 8) & 0xFF;
        var b = (rgb >> 0) & 0xFF;

        console.log("r=" + r + " g=" + g + " b=" + b);
      }

    }
    window.customElements.define(PixelArtApp.is, PixelArtApp);
  </script>
</dom-module>