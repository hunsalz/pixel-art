<link rel="import" href="../../bower_components/polymer/polymer-element.html">

<link rel="import" href="../../bower_components/paper-styles/color.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../bower_components/polymer/lib/mixins/gesture-event-listeners.html">

<link rel="import" href="../../bower_components/web-socket/web-socket.html">

<dom-module id="pixel-art-app">
  <template strip-whitespace>
    <style>
      :host {
        display: block;
      }

      .container {
        position: absolute;
        top: 0;
        left: 0;
        height: 100%;
        width: 100%;
        overflow: hidden;
        background: var(--paper-blue-grey-800);
      }

      #matrix {
        display: table;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) rotate(-90deg);
        border: 1px solid var(--paper-orange-700);
      }

      .row {
        display: table-row;
      }

      .pixel {
        display: table-cell;
        background: #000000;
        border: 1px solid var(--paper-orange-700);
      }

      .spacer {
        @apply --layout-flex;
      }

      #colors {
        display: table;
      }

      .color {
        display: table-cell;
        width: 100%;
        height: 100%;
      }

      .color:hover {
        padding: 4px;
      }

      @media screen and (orientation: landscape) {
        #palette {
          width: 24vh;
          height: 100%;
          @apply --layout-vertical;
          @apply --layout-center;
        }
        #colors {
          width: 10vh;
          height: 80vh;
          @apply --layout-vertical;
        }
        #matrix {
          width: 80vh;
          height: 80vh;
        }
      }

      @media screen and (orientation: portrait) {
        #palette {
          width: 100%;
          height: 24vw;
          @apply --layout-horizontal;
          @apply --layout-center;
        }
        #colors {
          width: 80vw;
          height: 10vw;
          @apply --layout-horizontal;
        }
        #matrix {
          width: 80vw;
          height: 80vw;
        }
      }
    </style>

    <div class="container">

      <!-- add pre-defined color palette -->
      <div id="palette">
        <span class="spacer"></span>
        <div id="colors">
          <div class="color" style="background: #FFFFFF" on-tap="__setColor"></div>
          <div class="color" style="background: #000000" on-tap="__setColor"></div>
          <div class="color" style="background: #B22222" on-tap="__setColor"></div>
          <div class="color" style="background: #008000" on-tap="__setColor"></div>
          <div class="color" style="background: #00008B" on-tap="__setColor"></div>
          <div class="color" style="background: #FFFF00" on-tap="__setColor"></div>
          <div class="color" style="background: #40E0D0" on-tap="__setColor"></div>
          <div class="color" style="background: #EE82EE" on-tap="__setColor"></div>
        </div>
        <span class="spacer"></span>
      </div>

      <!-- add matrix -->
      <div id="matrix">
        <template is="dom-repeat" items="{{columns}}" index-as="y">
          <div class="row">
            <template is="dom-repeat" items="{{rows}}" index-as="x">
              <div id="[[__index(x, y)]]" class="pixel" on-click="__setPixelColor"></div>
            </template>
          </div>
        </template>
      </div>
    </div>

    <!-- add websocket support -->
    <web-socket id="ws" auto url="[[url]]" state="{{state}}" verbose></web-socket>
  </template>

  <script>
    class PixelArtApp extends Polymer.GestureEventListeners(Polymer.Element) {

      static get is() { return 'pixel-art-app'; }

      static get properties() {
        return {
          url: {
            type: String,
            value: 'ws://' + window.location.hostname + ':8000/matrix'
            //value: 'ws://' + window.location.hostname + ':80/matrix'
            //value: 'ws://esp8266.local:80/matrix'
          },
          state: {
            type: Number,
            observer: '__handleWSStateChanges',
            notify: true
          },
          color: {
            type: String,
            value: '#FFFFFF' // default is white
          },
          columns: {
            type: Array,
            value: new Array(8),
            readOnly: true
          },
          rows: {
            type: Array,
            value: new Array(8),
            readOnly: true
          }
        };
      }

      __index(x, y) {
        // calculate index backwards for 8x8 matrix, so that first element of templating receives the highest ordinal number
        return (64 - (x * 8)) - (8 - y);
      }

      __handleWSStateChanges() {
        console.log("WS state: " + this.state);
      }

      __setColor(event) {

        console.log(event.target.style.background);


        // save color value
        this.color = event.target.style.background;
      }

      __setPixelColor(event) {

        //var hex = this.color.toString(16).replace('#', '0x');

        console.log(event.target.id + " = " + this.color);

        // var hsl = this.$.hsl;

        event.target.style.background = this.color;

        // console.log({ pixel: event.target.id, hue: hsl.hue, saturation: hsl.saturation, lightness: hsl.lightness });

        // this.$.ws.send({ pixel: event.target.id, hue: hsl.hue, saturation: hsl.saturation, lightness: hsl.lightness });
      }
    }
    window.customElements.define(PixelArtApp.is, PixelArtApp);
  </script>
</dom-module>